---
layout: layouts/doc-post.njk
title: 'アトリビューション レポート: システムの全概要'
subhead: 'アトリビューション レポートのコネクテッド サービスの概要
技術的な意思決定者を対象としています。'
description: 技術的な意思決定者を対象としたアトリビューション レポートのコネクテッド サービスの概要
date: 2022-08-09
authors:
  - alexandrawhite
---

<style type="text/css">
	.type figcaption {text-align:left;}
</style>

Attribution Reporting API を使用すると、アドテックや広告主は、広告クリックやビューが購入などのコンバージョンにつながったタイミングを測定できます。この API は、ビジネスニーズに応じて、クライアントサイドとサーバーサイドの統合の組み合わせに依存しています。

読み進める前に、「[アトリビューション レポートの概要](/docs/privacy-sandbox/attribution-reporting)」を必ずお読みください。これは、API の目的と、さまざまな出力レポート（[イベントレベルレポート](/docs/privacy-sandbox/attribution-reporting/#event-level-reports)と[要約レポート](/docs/privacy-sandbox/attribution-reporting/summary-reports/)）のフローを理解するのに役立ちます。なじみのない用語に遭遇した場合は、「[プライバシー サンドボックス用語集](/docs/privacy-sandbox/glossary/)」をご覧ください。

## この記事の対象者

以下に該当する方は、この記事を読むことをお勧めします。

- アドテックまたは広告主の**技術的意思決定者**。運用、DevOps、データ サイエンス、IT、マーケティングなどの部門で、実装に関する技術的な決定を行うことがあり、アトリビューション レポート システムに関する多くの提案がどのように連携して、プライバシーを保護する測定ツールを構築しているのかを知りたい方にお勧めです。
- あなたは、この API と Aggregation Service 環境を使用して実験をセットアップする**技術者**（開発者、システム オペレーター、システム アーキテクト、データ サイエンティストなど) です。

{% Aside %} 現時点では、サイト運営者はこの API を使用して何らかの措置をとる必要はありません。これが変更された場合、この記事はそれに応じて更新されます。 {% endAside %}

この記事では、サービスが Attribution Reporting API でどのように機能するかについて、概要をエンドツーエンドで説明します。技術者は、[統合されたプライバシーサンドボックスの関連性と測定のオリジントライアル](/blog/privacy-sandbox-unified-origin-trial/)を使用して、ローカルまたは本番環境で[この API を試す](/docs/privacy-sandbox/attribution-reporting-experiment/)ことができます。

## 概要

Attribution Reporting API は多数のサービスで構成されており、特定のセットアップ、クライアントサイドの構成、およびサーバーのデプロイが必要となります。何が必要かを特定するために、まず以下を行ってください。

- **[設計上の決定](#design-decisions)**。収集する情報を定義し、特定のキャンペーンで期待するコンバージョンを特定し、どの種類のレポートを収集するかを決定します。最終的な出力は、イベントレベルレポートと要約レポートのいずれかまたは両方です。

レポート機能をサポートするために、以下の 2 つ（場合によっては 3 つ）の要素が必ず存在します。

- **[ウェブサイトからブラウザへの通信](#web-browser-communication)**。Cookie ベースのシステムでは、コンバージョンと広告エンゲージメントの情報が ID に結び付けられ、後でこれらのイベントにユーザーまたは分析サービスを結合できます。この API を使用すると、ブラウザは分析用に配信される前に、ユーザーの指示に基づいてコンバージョンを広告のクリック/ビューに関連付けます。したがって、広告レンダリングコードとコンバージョントラッキングは以下のことを行う必要があります。
    - どのコンバージョンをどの広告クリックまたはインプレッションに関連付けるべきかをブラウザに伝えます。
    - 最終レポートに含めるその他のデータを伝達します。
- **[データ収集](#data-collection)**。ユーザーのブラウザで生成されたレポートを受信するためのコレクターエンドポイントが必要です。ブラウザからの出力は、イベントレベルのレポートと集計可能なレポート（暗号化され、要約レポートの生成に使用される）のいずれかです。

集計可能なレポートを収集した場合は、以下の 3 つ目の要素が必要になります。

- **[要約レポートの生成](#summary-report-generation)**。集計可能なレポートをバッチ化し、集計サービスを使用してレポートの処理を行い、要約レポートを生成します。

## 設計上の決定

アトリビューション レポートの重要な原則は、早い段階で設計を決定することです。どのカテゴリでどのデータを収集し、どれくらいの頻度でそのデータを処理するかを決定します。出力レポートからキャンペーンまたはビジネスに関するインサイトを得られます。

以下の出力レポートを取得できます。

- *イベントレベルレポート*: 特定の広告クリックまたはビュー（広告側）をコンバージョン側のデータと関連付けます。サイト間でのユーザー ID の結合を制限することでユーザーのプライバシーを保護できるように、コンバージョン側のデータは非常に限られており、データにはノイズが含まれています（ごく一部のケースでは、実際のレポートではなくランダムなデータが送信されます）。
- *[要約レポート](/docs/privacy-sandbox/attribution-reporting/summary-reports/)*: 広告側の特定のイベントに関連付けられていません。これらのレポートには、より詳細なコンバージョン データと、クリックとビューデータをコンバージョンデータに結合するための柔軟性があります。

レポートの選択によって、収集する必要があるデータが決まります。

最終的な出力は、意思決定に使用するツールへの入力と考えることができます。たとえば、要約レポートを生成して、総支出額につながったコンバージョン数を特定する場合、チームが総支出額を増やすことのできる次の広告キャンペーンのターゲットを決定するのに役立ちます。

何を測定するかを決定したら、Attribution Reporting API のクライアントサイドをセットアップできます。

## ウェブサイトからブラウザへの通信 {: #web-browser-communication }

{% Aside %} この API はテスト中ではありますが、コードで API が使用可能であることを確認し、適切な Permissions-Policy を設定する必要があります。 {% endAside %}

<figure class="screenshot">{% Img src="image/VbsHyyQopiec0718rMq2kTE1hke2/wO7uPRjjBsSoUGNN8M9B.png", alt="サイト運営者のウェブサイトのアトリビューション ソースは、広告主のウェブサイトのトリガーに接続します。", width="800", height="275" %}<figcaption><strong>図 1</strong> .</figcaption></figure>

### アトリビューション ソース（サイト運営者のウェブサイト） {: #attribution-sources}

*[アトリビューション ソース](https://docs.google.com/document/d/1BXchEk-UMgcr2fpjfXrQ3D8VhTR-COGYS1cwK_nyLfg/edit#heading=h.dmy7iuqnhvby)* は、広告関連のイベント（クリックまたはビュー）であり、アドテックは以下の種類の情報を添付できます。

- 広告クリエイティブ ID、キャンペーンに関する情報、地理情報などのコンテキストレポートデータ。
- ユーザーに終着してほしい広告のターゲットであるサイトのコンバージョンターゲット。これにより、特定のコンバージョンに対応するソースイベントがブラウザに通知されます。

アトリビューション ソースのデータが収集されると、ブラウザはデータをローカルストレージに追加するため、後でアトリビューション トリガーと照合できます。

### アトリビューション トリガー（広告主のウェブサイト）

*[アトリビューション トリガー](https://github.com/WICG/attribution-reporting-api/blob/main/AGGREGATE.md#attribution-trigger-registration)* は、コンバージョンを取得するよう API に指示するイベントです。

購入など、広告主にとって最も重要なコンバージョンをキャプチャすることをお勧めします。要約レポートには、複数のコンバージョン タイプとメタデータを取り込むことができます。

これにより、これらのイベントの集計結果が詳細かつ正確になります。

### ソースとトリガーの照合

ブラウザがアトリビューション トリガーのレスポンスを受信すると、ブラウザはローカルストレージにアクセスして、アトリビューション トリガーのオリジンとそのページ URL の [eTLD+1](https://web.dev/same-site-same-origin/#site) の両方に一致するソースを見つけます。

たとえば、ブラウザが `shoes.example/shoes123` の `adtech.example` からアトリビューション トリガーを受け取ると、ブラウザはローカルストレージで `adtech.example` と `shoes.example` の両方に一致するソースを探します。

*フィルター*（またはカスタムルール）を設定して、トリガーが特定のソースに一致するタイミングを決定できます。たとえば、特定の商品カテゴリのコンバージョンのみをカウントし、他のすべてのカテゴリを無視するようにフィルターを設定します。フィルターと優先順位付けモデルにより、より高度なアトリビューション レポートが可能になります。

ローカル ストレージに複数の属性ソースが見つかった場合、ブラウザは最近保存されたものを選択します。アトリビューション ソースに優先度が割り当てられている場合、ブラウザは最も優先度の高いソースを選択します。

## データ収集

同時に、対応するソースに一致するアトリビューション トリガーは、ブラウザによってアドテックが所有するサーバー上のレポートエンドポイント（収集エンドポイントまたは収集サービスと呼ばれることもあります）にレポートとして送信されます。これらのレポートは、イベントレベルレポートまたは集計可能なレポートです。

*[集計可能なレポート](https://github.com/WICG/conversion-measurement-api/blob/main/AGGREGATE.md#aggregatable-reports)* は、要約レポートの生成に使用されます。集計可能なレポートは、（サイト運営者のサイトで）広告から収集されたデータと（広告主のサイトからの）コンバージョンデータを組み合わせたもので、アドテックによって収集される前に、ユーザーのデバイスのブラウザによって生成され暗号化されます。

イベントレベルレポートには 2 ～ 30 日の遅延があります。集計可能なレポートは 1 時間以内にランダムな遅延で送信され、イベントは *[コントリビューション予算](https://github.com/WICG/attribution-reporting-api/blob/main/AGGREGATE.md#contribution-bounding-and-budgeting)* 内に収まる必要があります。これらの選択により、プライバシーが保護され、個々のユーザーのアクションの悪用が防止されます。

イベントレベルレポートのみに関心がある場合は、これが最後に必要となるインフラストラクチャの部分です。ただし、要約レポートを生成する場合は、追加のサービスを使用して集計可能なレポートを処理する必要があります。

## 要約レポートの生成

要約レポートを生成するには、 [集計サービス](https://github.com/google/trusted-execution-aggregation-service)（アドテックが運営）を使用して、集計可能なレポートを処理します。集計サービスは、ユーザーのプライバシーを保護するためにノイズを追加してから、最終的な要約レポートを返します。

<figure class="screenshot">{% Img src="image/VbsHyyQopiec0718rMq2kTE1hke2/ZBF0uMoXBDww805XVctQ.png", alt="集計可能なレポートが収集されると、バッチ化されてからアドテック環境に送信されます。", width="800", height="464" %}<figcaption> <strong>図 2</strong>. この図は、収集エンドポイントからアドテックが所有する集計サービスでの処理を通じてレポートのバッチ化を行う、データの非同期フローを表しています。<br><br> 収集された集計可能なレポートをバッチ化した後、バッチは集計サービスによって処理されます。<a href="https://github.com/WICG/attribution-reporting-api/blob/main/AGGREGATION_SERVICE_TEE.md#attestation-and-the-coordinator">コーディネーター</a>は、集計サービスの認証済みバージョンにのみ復号化キーを提供します。次に、集計サービスはデータを復号化して集約し、ノイズを追加してから結果を要約レポートとして返します。</figcaption></figure>

### バッチ化された集計可能なレポート

集計可能なレポートは、処理される前にバッチ化される必要があります。バッチは、戦略的にグループ化された集計可能なレポートで構成されます。この戦略は、特定の期間（毎日または毎週など）を反映することがほとんどです。この処理は、レポートエンドポイントとして機能する同じサーバーで実行できます。

シグナル対ノイズの比が高くなるように、バッチには多くのレポートを含める必要があります。

<figure class="screenshot">{% Img src="image/VbsHyyQopiec0718rMq2kTE1hke2/hjs2hU2e7N51a1CyNvsB.png", alt="期間が長いほどは結果に含まれるノイズが少なくなります。", width="614", height="317" %}<figcaption> <strong>図3</strong>. 1 日と 1 週間の待機期間を比較。1 時間後には、集計値が小さくなり、結果に含まれるノイズが多くなる可能性があります。1 日で集計値が大きくなるため、ノイズが少なくなる可能性があります。</figcaption></figure>

年に一度のセールなど、ボリュームがより高くなることが予想される特定のイベントを確実にキャプチャできるように、バッチ期間はいつでも変更できるようになっています。バッチ期間の変更は、アトリビューション ソースやトリガーを変更せずに行えます。

### 集計サービス

集計サービスには、集計可能なレポートを処理して要約レポートを生成する役割があります。集計可能なレポートは暗号化されており、信頼できる実行環境（TEE）で実行される集計サービスによってのみ読み取られます。

集計サービスは、[コーディネーターに復号化キーを要求](https://github.com/WICG/attribution-reporting-api/blob/main/AGGREGATION_SERVICE_TEE.md#attestation-and-the-coordinator)してデータの復号化と集計を行います。復号化と集計が完了すると、プライバシーを保護するために結果をノイズ処理し、要約レポートとして返します。

[集計サービスをローカルでテスト](https://github.com/google/trusted-execution-aggregation-service#set-up-local-testing)するには、技術者は集計可能なクリアテキスト形式のレポートを生成できます。または、[Nitro Enclaves を使用して AWS で暗号化されたレポートをテスト](https://github.com/google/trusted-execution-aggregation-service/#test-on-aws-with-support-for-encrypted-reports)することも可能です。

## 今後の予定

すべての人にとって機能する API を確実に構築できるように、皆さんとの対話を持ちたいと考えています。

### この API に関するディスカッション

他のプライバシーサンドボックス提案と同様に、この API は文書化され、[公に議論](/docs/privacy-sandbox/attribution-reporting-experiment/#join-the-discussion)されています。

### API を試す

Attribution Reporting API に関する[実験や会話に参加](/docs/privacy-sandbox/attribution-reporting-experiment/)できます。
